\documentclass[11pt,a4paper]{article}

\usepackage[margin=1in]{geometry}
\usepackage{listings}
\usepackage{color}
\usepackage{hyperref}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{
    language=c,
    aboveskip=3mm,
    belowskip=3mm,
    showstringspaces=false,
    basicstyle={\small\ttfamily},
    keywordstyle=\color{blue},
    commentstyle=\color{dkgreen},
    stringstyle=\color{mauve},
    breaklines=true,
    breakatwhitespace=true
}

\title{RC Project}
\author{Jo√£o Pereira, Nuno Pereira}

\begin{document}
    
\maketitle

\begin{abstract}
    TODO
\end{abstract}

% \pagebreak

% \tableofcontents

% \pagebreak

\section{Introduction}

TODO

\section{Architecture}

\subsection{Layers}

The code was divided into two distinct layers. This has the advantage of making the code more modular, reusable and versatile, as either layer could be swapped for another with a similar interface with minimal effort.

\subsubsection{Data Link Layer}

This is the lower level layer, it interfaces with the serial port driver directly. It is responsible for ensuring the data gets sent and received.

\subsubsection{Application Layer}

This is the higher level layer, it interfaces with the data link layer and with the file system. It is responsible for reading a file, breaking it up into chunks, sending these chunks through the data link layer, receiving these chunks, and assembling them back into a file.

\subsection{Program Execution}

The program can be executed by calling \lstinline{app serial_port role file_name}, where:

\begin{itemize}
    \item \lstinline{app} is the program executable;
    \item \lstinline{serial_port} is the serial port file path;
    \item \lstinline{role} is one of \lstinline{rx|tx}, for receiving or transmitting a file, respectively;
    \item \lstinline{file_name} is the path of the file to be sent.
\end{itemize}

\section{Code Structure}

\subsection{Data Link Layer}
\label{sec:dll}

The Data Link Layer is centered on the \textit{link\_layer.c} file and the \textit{link\_layer} folder.
The \textit{link\_layer.c} file contains the protocol interface that can be used by upper layers, the \textit{link\_layer/timer.c} file contains code related to interfacing with POSIX timers, and the \textit{link\_layer/frame.c} file contains code to create and manipulate frames.

\subsubsection{link\_layer.c}

\begin{itemize}
    \item \begin{lstlisting}
typedef enum { LL_TX, LL_RX } LLRole;
    \end{lstlisting}

    Defines the role of a link layer connection.

    \item \begin{lstlisting}
typedef struct {
    char serial_port[50];
    LLRole role;
    int baud_rate;
    int n_retransmissions;
    int timeout;
} LLConnectionParams;
    \end{lstlisting}

    Defines the parameters required to create a new link layer connection.

    \item \begin{lstlisting}
struct _LLConnection {
    LLConnectionParams params;
    struct termios old_termios;
    int fd;
    bool closed;
    uint8_t tx_sequence_nr;
    uint8_t rx_sequence_nr;
    int n_retransmissions_sent;
    timer_t timer;
    Frame *last_command_frame;
};
    \end{lstlisting}

    Defines the state of a link layer connection.

    \item \begin{lstlisting}
LLConnection *llopen(LLConnectionParams params);
    \end{lstlisting}

    Opens a new link layer connection and returns it.

    \item \begin{lstlisting}
ssize_t llwrite(LLConnection *connection,
    const uint8_t *buf, size_t buf_len);
    \end{lstlisting}

    Sends data through a connection.

    \item \begin{lstlisting}
ssize_t llread(LLConnection *connection, uint8_t *buf);
    \end{lstlisting}

    Reads data from a connection.

    \item \begin{lstlisting}
int llclose(LLConnection *connection, bool show_stats);
    \end{lstlisting}

    Closes a connection.
\end{itemize}

\subsubsection{link\_layer/timer.c}

\begin{itemize}
    \item \begin{lstlisting}
void timer_setup(LLConnection *connection);
    \end{lstlisting}

    Sets up a connection's POSIX timer.

    \item \begin{lstlisting}
void timer_destroy(LLConnection *connection);
    \end{lstlisting}

    Deallocates a connection's POSIX timer.

    \item \begin{lstlisting}
void timer_arm(LLConnection *connection);
    \end{lstlisting}

    Starts a connection's POSIX timer.

    \item \begin{lstlisting}
void timer_disarm(LLConnection *connection);
    \end{lstlisting}

    Stops a connection's POSIX timer.

    \item \begin{lstlisting}
void timer_force(LLConnection *connection);
    \end{lstlisting}

    Forcibly calls a connection's timer handler.
\end{itemize}

\subsubsection{link\_layer/frame.c}

\begin{itemize}
    \item \begin{lstlisting}
typedef struct {
    uint8_t address;
    uint8_t command;
    ByteVector *information;
} Frame;
    \end{lstlisting}

    Defines all the data needed to represent a frame.

    \item \begin{lstlisting}
Frame *create_frame(LLConnection *connection, uint8_t cmd);
    \end{lstlisting}

    Creates a new frame.

    \item \begin{lstlisting}
Frame *read_frame(LLConnection *connection);
    \end{lstlisting}

    Reads a frame from the connection's serial port.

    \item \begin{lstlisting}
ssize_t write_frame(LLConnection *connection, Frame *frame);
    \end{lstlisting}

    Writes a frame to the connection's serial port.

    \item \begin{lstlisting}
void frame_destroy(Frame *this);
    \end{lstlisting}

    Deallocates all memory allocated by a frame.

    \item \begin{lstlisting}
ssize_t send_frame(LLConnection *connection, Frame *frame);
    \end{lstlisting}

    Sends a frame to the connection's serial port and sets up retransmission if the frame is a command.

    \item \begin{lstlisting}
Frame *expect_frame(LLConnection *connection, uint8_t command);
    \end{lstlisting}

    Receives frames from a connection until a certain command is received.
\end{itemize}

\subsection{Application Layer}

The Application Layer is centered around the \textit{application\_layer.c} file and the \textit{application\_layer} folder.
The \textit{application\_layer.c} file contains the client facing interface of the application which is responsible for all the higher level setup and communication between transmitter and receiver.
The \textit{application\_layer/packet.c} file contains code that is responsible for correctly creating control and data packets.

\subsubsection{application\_layer.c}

\begin{itemize}
    \item \begin{lstlisting}
LLConnectionParams setupLLParams(const char *serial_port, const char *role, int baud_rate, int nTries, int timeout);
    \end{lstlisting}

    Compiles the parameters given to the application layer into a LLConnectionParams object to be used by the underlying \hyperref[sec:dll]{Data Link Layer}.

    \item \begin{lstlisting}
LLConnection *connect(LLConnectionParams ll);
    \end{lstlisting}

    Opens a connection to one of the computer's serial ports.

    \item \begin{lstlisting}
int init_transmission(LLConnection *connection, char *filename);
    \end{lstlisting}

    Starts the communication process between transmitter and receiver.

    \item \begin{lstlisting}
ssize_t receiver(LLConnection *connection);
    \end{lstlisting}

    Executes the receiver's operational flow.

    \item \begin{lstlisting}
ssize_t receiver(LLConnection *connection);
    \end{lstlisting}
        
    Executes the transmitter's operational flow.

    \item \begin{lstlisting}
void sig_handler(int sig);
    \end{lstlisting}

    Handles OS signals. Currently unused.

    \item \begin{lstlisting}
int setup_signal_handlers();
    \end{lstlisting}

    Installs signal handlers for the various interceptable signals that might terminate the program in order to perform any necessary cleanup.

    \item \begin{lstlisting}
void applicationLayer(const char *serial_port, const char *role, int baud_rate, int n_tries, int timeout, const char *filename);
    \end{lstlisting}

    Entrypoint for the application layer.

\end{itemize}

\subsubsection{application\_layer/packet.c}

\begin{itemize}
    \item \begin{lstlisting}
ByteVector *create_start_packet(size_t file_size, const char *file_name);
    \end{lstlisting}

    Creates a \textbf{START} packet containing the transmitted file's size and name.

\end{itemize}

\section{Main Use Cases}

There are two main use cases: either sending a file or receiving a file.
These use cases are described below.

\subsection{Sending a file}

TODO

\subsection{Receiving a file}

TODO

\section{Link Layer Protocol}

The link layer protocol's flow is as follows: open a connection using llopen, send arbitrary data using llwrite, receive arbitrary data using llread, and close the connection using llclose. Each step's implementation is described below.

\subsection{llopen}

\subsection{llwrite}

\subsection{llread}

\subsection{llclose}

\section{Application Layer Protocol}

TODO

\section{Validation}

TODO

\section{Link Layer Efficiency}

TODO

\section{Conclusions}

TODO

\pagebreak
\appendix
\section{Appendix}

\subsection{Code}

In folder \textit{code/}.

\subsection{Figures}

TODO

\end{document}
